<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº»å°‡æˆ°ç¸¾ç´€éŒ„è¡¨ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --accent-gold: #f1c40f;
            --accent-green: #2ecc71;
            --record-plus: #2ecc71;
            --record-minus: #e74c3c;
            --border: #333;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; justify-content: center; }
        .container { width: 100vw; max-width: 500px; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        h2 { color: var(--accent-gold); text-align: center; }
        .hidden { display: none; }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 5px; background: #222; color: white; box-sizing: border-box; font-size: 16px !important; }
        .flex-row { display: flex; gap: 8px; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; font-weight: bold; }
        .btn-main { background: var(--accent-gold); color: black; }
        .btn-add { background: var(--accent-green); color: white; margin-bottom: 20px; }
        .btn-cancel { background: #444; color: white; }
        .btn-logout { background: transparent; color: #888; border: 1px solid #444; margin-top: 10px; font-size: 12px; }
        .btn-data { background: #34495e; color: white; font-size: 14px; margin-top: 10px; }

        /* è¨˜ä½å¯†ç¢¼æ¨£å¼ */
        .remember-me { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #aaa; margin-top: 10px; cursor: pointer; }
        .remember-me input { width: auto; height: auto; margin: 0; }

        /* å„€è¡¨æ¿ */
        .total-box { border: 1px solid var(--accent-gold); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .chart-container { background: #1a1a1a; padding: 10px; border-radius: 8px; margin-bottom: 20px; height: 180px; }

        /* ç´€éŒ„å¡ç‰‡ */
        .record-card { border-bottom: 1px solid var(--border); padding: 15px 5px; }
        .row-1 { font-size: 14px; color: #aaa; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .row-2 { font-size: 16px; margin-bottom: 5px; }
        .row-3 { display: flex; justify-content: space-between; align-items: flex-end; font-size: 15px; }
        
        .amount { font-size: 18px; font-weight: bold; }
        .plus { color: var(--record-plus); }
        .minus { color: var(--record-minus); }
        .action-btns { display: flex; gap: 10px; }
        .btn-edit { color: #3498db; cursor: pointer; font-size: 12px; }
        .btn-del { color: var(--record-minus); cursor: pointer; font-size: 12px; }
        .na-text { color: #555; text-decoration: line-through; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section">
        <h2>éº»å°‡ç´€éŒ„ç³»çµ±</h2>
        <div class="form-group"><label>å¸³è™Ÿ</label><input type="text" id="username"></div>
        <div class="form-group"><label>å¯†ç¢¼ (5ç¢¼ä»¥ä¸Š)</label><input type="password" id="password"></div>
        <label class="remember-me">
            <input type="checkbox" id="remember-checkbox"> è¨˜ä½å¸³è™Ÿå¯†ç¢¼
        </label>
        <button class="btn-main" onclick="handleAuth()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="dashboard-section" class="hidden">
        <h2 id="welcome-msg">æ­¡è¿</h2>
        <div class="total-box">
            <div style="color: #aaa; font-size: 14px;">ç”Ÿæ¶¯ç¸½ç´¯ç©</div>
            <div id="grand-total" style="font-size: 28px; font-weight: bold; margin-bottom: 10px;">$ 0</div>
            <div class="chart-container"><canvas id="scoreChart"></canvas></div>
        </div>
        <button class="btn-add" onclick="openForm()">+ æ–°å¢ç´€éŒ„</button>
        <div id="history-list"></div>
        
        <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 10px;">
            <button class="btn-data" onclick="exportData()">ğŸ’¾ è¤‡è£½å‚™ä»½æ•¸æ“š</button>
            <button class="btn-data" onclick="importData()">ğŸ“‚ é‚„åŸ/åŒ¯å…¥æ•¸æ“š</button>
            <button class="btn-logout" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</button>
        </div>
    </div>

    <div id="record-form-section" class="hidden">
        <h2 id="form-title">æ–°å¢å°å±€</h2>
        <input type="hidden" id="edit-index">
        <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="play-date"></div>
        <div class="form-group">
            <label>å°æ‰‹ä»£è™Ÿ</label>
            <div class="flex-row">
                <input type="text" id="p-up" placeholder="ä¸Š">
                <input type="text" id="p-mid" placeholder="å°">
                <input type="text" id="p-down" placeholder="ä¸‹">
            </div>
        </div>
        <div class="flex-row">
            <div class="form-group" style="flex:1"><label>èƒ¡ç‰Œ</label><input type="text" id="win-count"></div>
            <div class="form-group" style="flex:1"><label>æ”¾æ§</label><input type="text" id="lose-count"></div>
            <div class="form-group" style="flex:1"><label>è‡ªæ‘¸</label><input type="text" id="draw-count"></div>
        </div>
        <div class="form-group"><label>æœ€çµ‚è¼¸è´é‡‘é¡</label><input type="number" id="final-amount"></div>
        <button class="btn-add" onclick="saveRecord()">ç¢ºèªå„²å­˜</button>
        <button class="btn-cancel" onclick="showSection('dashboard-section')">å–æ¶ˆ</button>
    </div>
</div>

<script>
    let currentUser = null;
    let scoreChart = null;

    // è£œå›ï¼šè‡ªå‹•å¡«å…¥é‚è¼¯
    window.onload = function() {
        const savedAuth = JSON.parse(localStorage.getItem('mj_remembered') || 'null');
        if (savedAuth) {
            document.getElementById('username').value = savedAuth.user;
            document.getElementById('password').value = savedAuth.pass;
            document.getElementById('remember-checkbox').checked = true;
        }
    };

    function showSection(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function handleAuth() {
        const user = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value;
        const remember = document.getElementById('remember-checkbox').checked;

        if (!user || pass.length < 5) return alert('å¸³è™Ÿå¯†ç¢¼æ ¼å¼ä¸ç¬¦');
        let accounts = JSON.parse(localStorage.getItem('mj_accounts') || '{}');
        
        if (!accounts[user]) {
            accounts[user] = pass;
            localStorage.setItem('mj_accounts', JSON.stringify(accounts));
        } else if (accounts[user] !== pass) return alert('å¯†ç¢¼éŒ¯èª¤');

        // è£œå›ï¼šè¨˜ä½å¸³å¯†å„²å­˜é‚è¼¯
        if (remember) {
            localStorage.setItem('mj_remembered', JSON.stringify({ user, pass }));
        } else {
            localStorage.removeItem('mj_remembered');
        }

        currentUser = user;
        showSection('dashboard-section');
        loadRecords();
    }

    function logout() { currentUser = null; showSection('auth-section'); }

    function exportData() {
        const allData = JSON.parse(localStorage.getItem('mj_data') || '{}');
        const userData = allData[currentUser] || [];
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(userData))));
        navigator.clipboard.writeText(encoded).then(() => alert('æ•¸æ“šå·²è¤‡è£½ï¼'));
    }

    function importData() {
        const code = prompt('è«‹è²¼ä¸Šæ•¸æ“šï¼š');
        if (!code) return;
        try {
            const data = JSON.parse(decodeURIComponent(escape(atob(code))));
            let allData = JSON.parse(localStorage.getItem('mj_data') || '{}');
            allData[currentUser] = data;
            localStorage.setItem('mj_data', JSON.stringify(allData));
            loadRecords();
            alert('åŒ¯å…¥æˆåŠŸ');
        } catch(e) { alert('ç„¡æ•ˆä»£ç¢¼'); }
    }

    function saveRecord() {
        const editIndex = parseInt(document.getElementById('edit-index').value);
        const record = {
            date: document.getElementById('play-date').value,
            pUp: document.getElementById('p-up').value || "-",
            pMid: document.getElementById('p-mid').value || "-",
            pDown: document.getElementById('p-down').value || "-",
            win: document.getElementById('win-count').value || "0",
            lose: document.getElementById('lose-count').value || "0",
            draw: document.getElementById('draw-count').value || "0",
            amount: parseInt(document.getElementById('final-amount').value) || 0
        };
        let allData = JSON.parse(localStorage.getItem('mj_data') || '{}');
        if (!allData[currentUser]) allData[currentUser] = [];
        if (editIndex === -1) allData[currentUser].push(record);
        else allData[currentUser][editIndex] = record;
        localStorage.setItem('mj_data', JSON.stringify(allData));
        showSection('dashboard-section');
        loadRecords();
    }

    function deleteRecord(index) {
        if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
            let allData = JSON.parse(localStorage.getItem('mj_data') || '{}');
            allData[currentUser].splice(index, 1);
            localStorage.setItem('mj_data', JSON.stringify(allData));
            loadRecords();
        }
    }

    function openForm(editIndex = -1) {
        const allData = JSON.parse(localStorage.getItem('mj_data') || '{}');
        const myRecords = allData[currentUser] || [];
        document.getElementById('edit-index').value = editIndex;
        if (editIndex !== -1) {
            const r = myRecords[editIndex];
            document.getElementById('play-date').value = r.date;
            document.getElementById('p-up').value = r.pUp;
            document.getElementById('p-mid').value = r.pMid;
            document.getElementById('p-down').value = r.pDown;
            document.getElementById('win-count').value = r.win;
            document.getElementById('lose-count').value = r.lose;
            document.getElementById('draw-count').value = r.draw;
            document.getElementById('final-amount').value = r.amount;
        } else {
            document.getElementById('play-date').value = new Date().toISOString().split('T')[0];
            ['p-up', 'p-mid', 'p-down', 'win-count', 'lose-count', 'draw-count', 'final-amount'].forEach(id => document.getElementById(id).value = '');
        }
        showSection('record-form-section');
    }

    function updateChart(recentRecords) {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        const dataValues = recentRecords.map(r => r.amount);
        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: recentRecords.map((_,i)=>i+1), 
                datasets: [{ data: dataValues, backgroundColor: dataValues.map(v => v >= 0 ? '#2ecc71' : '#e74c3c') }] 
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } }
            }
        });
    }

    function loadRecords() {
        const allData = JSON.parse(localStorage.getItem('mj_data') || '{}');
        const myRecords = allData[currentUser] || [];
        const listContainer = document.getElementById('history-list');
        const totalDisplay = document.getElementById('grand-total');
        let totalSum = 0;
        myRecords.forEach(r => totalSum += r.amount);
        totalDisplay.innerText = `$ ${totalSum}`;
        totalDisplay.className = `amount ${totalSum >= 0 ? 'plus' : 'minus'}`;
        
        updateChart([...myRecords].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-20));
        
        listContainer.innerHTML = '';
        myRecords.map((r, i) => ({...r, idx: i})).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
            const card = document.createElement('div');
            card.className = 'record-card';
            const fmt = (v) => v.toString().toLowerCase() === 'x' ? '<span class="na-text">X</span>' : v;
            
            card.innerHTML = `
                <div class="row-1">
                    <span>${r.date}</span>
                    <div class="action-btns">
                        <span class="btn-edit" onclick="openForm(${r.idx})">ç·¨è¼¯</span>
                        <span class="btn-del" onclick="deleteRecord(${r.idx})">åˆªé™¤</span>
                    </div>
                </div>
                <div class="row-2">ä¸Š: ${r.pUp} | å°: ${r.pMid} | ä¸‹: ${r.pDown}</div>
                <div class="row-3">
                    <div>èƒ¡: ${fmt(r.win)} | æ”¾: ${fmt(r.lose)} | æ‘¸: ${fmt(r.draw)}</div>
                    <div class="amount ${r.amount >= 0 ? 'plus' : 'minus'}">
                        è¼¸è´çµæœ ${r.amount >= 0 ? '+' : ''}${r.amount}
                    </div>
                </div>
            `;
            listContainer.appendChild(card);
        });
    }
</script>
</body>
</html>
